name: Test ADB Connection

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Oracle Instant Client + SQL*Plus
      run: |
        sudo apt-get update
        sudo apt-get install -y libaio1t64 unzip wget

        # Fix libaio needed for Oracle
        sudo ln -s /lib/x86_64-linux-gnu/libaio.so.1t64 /lib/x86_64-linux-gnu/libaio.so.1

        # Download Instant Client packages
        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-basic-linux.x64-19.27.0.0.0dbru.zip
        unzip -o instantclient-basic-linux.x64-19.27.0.0.0dbru.zip -d $HOME

        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip
        unzip -o instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip -d $HOME

        # Add to PATH
        echo "$HOME/instantclient_19_27" >> $GITHUB_PATH
        export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH

        sqlplus -v

    - name: Copy Wallet Files (from cicd-adb/wallet folder)
      run: |
        mkdir -p $HOME/adb_wallet
        cp cicd-adb/wallet/* $HOME/adb_wallet/

        echo "Wallet contents:"
        ls -R $HOME/adb_wallet

    - name: Test SQL Connection
      env:
        ADB_USER: ${{ secrets.ADB_USER }}
        ADB_PASSWORD: ${{ secrets.ADB_PASSWORD }}
        ADB_TNS: ${{ secrets.ADB_TNS }}
      run: |
        export TNS_ADMIN=$HOME/adb_wallet
        export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH
        export PATH=$HOME/instantclient_19_27:$PATH

        echo "Using TNS alias: $ADB_TNS"
        
        echo "--- sqlnet.ora ---"
        cat $HOME/adb_wallet/sqlnet.ora

        echo "--- tnsnames.ora ---"
        cat $HOME/adb_wallet/tnsnames.ora

        echo "Testing connection..."
        echo "SELECT SYSDATE FROM dual;" | sqlplus "$ADB_USER/$ADB_PASSWORD@$ADB_TNS"





