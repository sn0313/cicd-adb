name: Test ADB Connection

on:
  workflow_dispatch: {}

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Oracle Instant Client + SQL*Plus
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 unzip
          # Basic Instant Client
          wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-basic-linux.x64-19.27.0.0.0dbru.zip
          unzip -o instantclient-basic-linux.x64-19.27.0.0.0dbru.zip -d $HOME/instantclient
          # SQL*Plus package
          wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip
          unzip -o instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip -d $HOME/instantclient
          export LD_LIBRARY_PATH=$HOME/instantclient/instantclient_19_27:$LD_LIBRARY_PATH
          export PATH=$HOME/instantclient/instantclient_19_27:$PATH
          sqlplus -v



    - name: Prepare Wallet
      run: |
        echo "${{ secrets.ADB_WALLET }}" | base64 --decode > wallet.zip
        unzip wallet.zip -d $HOME/adb_wallet

    - name: Test SQL Connection
      run: |
        export TNS_ADMIN=$HOME/adb_wallet
        echo "SELECT sysdate FROM dual;" | sqlplus ${{ secrets.ADB_USER }}/$ {{ secrets.ADB_PASSWORD }}@${{ secrets.ADB_TNS }}


cur = conn.cursor()
cur.execute("SELECT sysdate FROM dual")
print("Database connection successful, sysdate =", cur.fetchone
