name: Test ADB Connection

on:
  workflow_dispatch:  # allows manual run for testing

jobs:
  test-connection:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Oracle Instant Client
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip libaio1
        # Add Oracle repository for Instant Client 19
        sudo apt-get install -y wget
        wget https://download.oracle.com/otn_software/linux/instantclient/1912000/oracle-instantclient19.12-basiclite_19.12.0.0.0-1_amd64.deb
        sudo dpkg -i oracle-instantclient19.12-basiclite_19.12.0.0.0-1_amd64.deb
        export LD_LIBRARY_PATH=/usr/lib/oracle/19.12/client64/lib:$LD_LIBRARY_PATH

    - name: Prepare Wallet
      run: |
        echo "${{ secrets.ADB_WALLET }}" | base64 --decode > wallet.zip
        unzip wallet.zip -d $HOME/adb_wallet

    - name: Test SQL Connection
      run: |
        export TNS_ADMIN=$HOME/adb_wallet
        echo "SELECT sysdate FROM dual;" | sqlplus ${{ secrets.ADB_USER }}/$ {{ secrets.ADB_PASSWORD }}@${{ secrets.ADB_TNS }}
