name: Run SQL Script

on:
  workflow_dispatch:

jobs:
  run-sql:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libaio1 unzip

    - name: Download Oracle Instant Client
      run: |
        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-basiclite-linux.x64-19.27.0.0.0dbru.zip
        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip
        unzip instantclient-basiclite-linux.x64-19.27.0.0.0dbru.zip -d $HOME
        unzip instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip -d $HOME

        echo "$HOME/instantclient_19_27" >> $GITHUB_PATH
        export LD_LIBRARY_PATH=$HOME/instantclient_19_27:${LD_LIBRARY_PATH}

    - name: Set up wallet
      run: |
        mkdir -p $HOME/adb_wallet
        cp -r wallet/* $HOME/adb_wallet

        export TNS_ADMIN=$HOME/adb_wallet
        echo "Using TNS_ADMIN = $TNS_ADMIN"

        echo "--- tnsnames.ora ---"
        cat $TNS_ADMIN/tnsnames.ora

    - name: Test SQL*Plus connection
      env:
        ADB_USER: ${{ secrets.ADB_USER }}
        ADB_PASSWORD: ${{ secrets.ADB_PASSWORD }}
        ADB_TNS: ${{ secrets.ADB_TNS }}

      run: |
        export TNS_ADMIN=$HOME/adb_wallet
        echo "Testing connection..."
        echo "exit" | sqlplus "$ADB_USER/$ADB_PASSWORD@$ADB_TNS"



