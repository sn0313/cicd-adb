name: Test ADB Connection

on:
  workflow_dispatch:  # allows manual run for testing

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Oracle Instant Client via rpm + alien
      run: |
      sudo apt-get update
      sudo apt-get install -y libaio1 alien wget
      wget https://yum.oracle.com/repo/OracleLinux/OL7/oracle/instantclient/x86_64/oracle-instantclient19.12-basiclite-19.12.0.0.0-1.x86_64.rpm
      sudo alien -i --scripts oracle-instantclient19.12-basiclite-19.12.0.0.0-1.x86_64.rpm
      export LD_LIBRARY_PATH=/usr/lib/oracle/19.12/client64/lib:$LD_LIBRARY_PATH


    - name: Prepare Wallet
      run: |
        echo "${{ secrets.ADB_WALLET }}" | base64 --decode > wallet.zip
        unzip wallet.zip -d $HOME/adb_wallet

    - name: Test SQL Connection
      run: |
        export TNS_ADMIN=$HOME/adb_wallet
        echo "SELECT sysdate FROM dual;" | sqlplus ${{ secrets.ADB_USER }}/$ {{ secrets.ADB_PASSWORD }}@${{ secrets.ADB_TNS }}


cur = conn.cursor()
cur.execute("SELECT sysdate FROM dual")
print("Database connection successful, sysdate =", cur.fetchone
