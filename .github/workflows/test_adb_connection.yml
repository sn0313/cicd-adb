name: CI Oracle SQL

on:
  workflow_dispatch:

jobs:
  run-sql:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y libaio1 unzip

    - name: Install Oracle Instant Client (Basic + SQLPlus)
      run: |
        wget https://download.oracle.com/otn_software/linux/instantclient/instantclient-basiclite-linux.x64-19.27.0.0.0dbru.zip
        wget https://download.oracle.com/otn_software/linux/instantclient/instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip

        unzip instantclient-basiclite-linux.x64-19.27.0.0.0dbru.zip -d $HOME
        unzip instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip -d $HOME

        echo "$HOME/instantclient_19_27" >> $GITHUB_PATH
        export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH

    - name: Set TNS_ADMIN (point to repo wallet folder)
      run: |
        echo "Setting TNS_ADMIN to $GITHUB_WORKSPACE/wallet"
        export TNS_ADMIN=$GITHUB_WORKSPACE/wallet
        echo "TNS_ADMIN=$TNS_ADMIN" >> $GITHUB_ENV

    - name: Debug Wallet Folder
      run: |
        echo "Wallet directory content:"
        ls -al $GITHUB_WORKSPACE/wallet

    - name: Run SQL script
      env:
        ADB_USER: ${{ secrets.ADB_USER }}
        ADB_PASSWORD: ${{ secrets.ADB_PASSWORD }}
        ADB_TNS: ${{ secrets.ADB_TNS }}
      run: |
        echo "Connecting to ADB using alias: $ADB_TNS"
        echo "exit" | sqlplus "${ADB_USER}/${ADB_PASSWORD}@${ADB_TNS}"





