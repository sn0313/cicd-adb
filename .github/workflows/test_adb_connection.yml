name: Test ADB Connection

on:
  workflow_dispatch:  # allows manual run for testing

jobs:
  test-connection:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Python and oracledb
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip libaio1 unzip
        python3 -m pip install --upgrade pip
        python3 -m pip install oracledb

    - name: Prepare Wallet
      run: |
        echo "${{ secrets.ADB_WALLET }}" | base64 --decode > wallet.zip
        unzip wallet.zip -d $HOME/adb_wallet

    - name: Test SQL Connection via Python
      run: |
        python3 - <<EOF
        import os
        import oracledb

        # Set wallet path
        os.environ["TNS_ADMIN"] = os.path.expanduser("$HOME/adb_wallet")

        # Connect using secrets
        conn = oracledb.connect(
            user=os.environ.get("ADB_USER"),
            password=os.environ.get("ADB_PASSWORD"),
            dsn=os.environ.get("ADB_TNS")
        )

        cur = conn.cursor()
        cur.execute("SELECT sysdate FROM dual")
        print("Database connection successful, sysdate =", cur.fetchone()[0])
EOF

