name: Test ADB Connection

on:
  workflow_dispatch: {}

jobs:
  test-connection:
    runs-on: ubuntu-latest

    env:
      LD_LIBRARY_PATH: ${{ github.workspace }}/instantclient/instantclient_19_27
      PATH: ${{ github.workspace }}/instantclient/instantclient_19_27:${{ env.PATH }}
      TNS_ADMIN: ${{ github.workspace }}/adb_wallet
      ADB_USER: ${{ secrets.ADB_USER }}
      ADB_PASSWORD: ${{ secrets.ADB_PASSWORD }}
      ADB_TNS: ${{ secrets.ADB_TNS }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Oracle Instant Client + SQL*Plus
      run: |
        sudo apt-get update
        sudo apt-get install -y libaio-dev unzip wget

        mkdir -p $HOME/instantclient

        # Download and unzip Basic Client
        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-basic-linux.x64-19.27.0.0.0dbru.zip
        unzip -o instantclient-basic-linux.x64-19.27.0.0.0dbru.zip -d $HOME/instantclient

        # Download and unzip SQL*Plus package
        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip
        unzip -o instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip -d $HOME/instantclient

        # Verify sqlplus installation
        $HOME/instantclient/instantclient_19_27/sqlplus -v

    - name: Prepare Wallet
      run: |
        mkdir -p $HOME/adb_wallet
        echo "${{ secrets.ADB_WALLET }}" | base64 --decode > wallet.zip
        unzip -o wallet.zip -d $HOME/adb_wallet

    - name: Test SQL Connection with SQL*Plus
      run: |
        echo "SELECT sysdate FROM dual;" | $HOME/instantclient/instantclient_19_27/sqlplus $ADB_USER/$ADB_PASSWORD@$ADB_TNS

    - name: Test SQL Connection with Python (optional)
      run: |
        python3 -m pip install oracledb
        python3 - <<EOF
        import os
        import oracledb

        os.environ["TNS_ADMIN"] = os.path.expanduser("$HOME/adb_wallet")
        conn = oracledb.connect(
            user=os.environ.get("ADB_USER"),
            password=os.environ.get("ADB_PASSWORD"),
            dsn=os.environ.get("ADB_TNS")
        )
        cur = conn.cursor()
        cur.execute("SELECT sysdate FROM dual")
        print("Database connection successful, sysdate =", cur.fetchone()[0])
EOF

