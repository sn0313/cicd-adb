name: Test ADB DEV + PROD Connections (Full Debug)

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Oracle Instant Client + SQL*Plus + DNS Utilities
      run: |
        sudo apt-get update
        sudo apt-get install -y libaio1t64 unzip wget dnsutils iputils-ping

        # Fix missing libaio.so.1
        sudo ln -s /lib/x86_64-linux-gnu/libaio.so.1t64 /lib/x86_64-linux-gnu/libaio.so.1

        # Install Instant Client
        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-basic-linux.x64-19.27.0.0.0dbru.zip
        unzip -o instantclient-basic-linux.x64-19.27.0.0.0dbru.zip -d $HOME

        wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip
        unzip -o instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip -d $HOME

        export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH
        export PATH=$HOME/instantclient_19_27:$PATH
        sqlplus -v

    ###########################################################################
    # DEV
    ###########################################################################
    - name: Prepare DEV Wallet
      run: |
        mkdir -p $HOME/adb_wallet_dev
        cp -r $GITHUB_WORKSPACE/wallet/* $HOME/adb_wallet_dev/
        chmod 600 $HOME/adb_wallet_dev/*

        # Add debugging flags to sqlnet.ora
        cat > $HOME/adb_wallet_dev/sqlnet.ora <<EOF
        WALLET_LOCATION = (SOURCE = (METHOD = file)(METHOD_DATA = (DIRECTORY="$HOME/adb_wallet_dev")))
        SSL_SERVER_DN_MATCH = yes

        TRACE_LEVEL_CLIENT = USER
        TRACE_DIRECTORY_CLIENT = $HOME/adb_wallet_dev
        TRACE_FILE_CLIENT = trace_dev.log
        DIAG_ADR_ENABLED = OFF
        EOF

        echo "--- DEV WALLET CONTENTS ---"
        ls -R $HOME/adb_wallet_dev

    - name: Show DEV tnsnames.ora
      run: |
        echo "--- DEV tnsnames.ora ---"
        cat $HOME/adb_wallet_dev/tnsnames.ora

    - name: DNS Debug for DEV host
      run: |
        DEV_HOST=$(grep -oP '(?<=HOST = ).*(?=\))' $HOME/adb_wallet_dev/tnsnames.ora | head -n1)
        echo "DEV HOST = $DEV_HOST"

        echo "--- nslookup ---"
        nslookup $DEV_HOST || true

        echo "--- dig ---"
        dig $DEV_HOST || true

        echo "--- ping ---"
        ping -c 4 $DEV_HOST || true

    - name: Test SQL Connection (DEV) With Verbose Logs
      run: |
        export TNS_ADMIN=$HOME/adb_wallet_dev
        export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH
        export PATH=$HOME/instantclient_19_27:$PATH

        echo "CONNECT STRING = ${{ secrets.ADB_USER }}/${{ secrets.ADB_PASSWORD }}@${{ secrets.ADB_TNS }}"
        
        # List Wallet files
        echo "--- WALLET FILES ---"
        ls -l $TNS_ADMIN

        echo "--- SQLPLUS DEBUG ---"
        sqlplus -lint -prelim /nolog <<EOF
        conn ${{ secrets.ADB_USER }}/${{ secrets.ADB_PASSWORD }}@${{ secrets.ADB_TNS }}
        EOF

        echo "--- TRACE LOG (if exists) ---"
        cat $HOME/adb_wallet_dev/trace_dev.log || true

    ###########################################################################
    # PROD
    ###########################################################################
    - name: Prepare PROD Wallet
      run: |
        mkdir -p $HOME/adb_wallet_prod

        if [ -n "${{ secrets.ADB_PROD_WALLET }}" ]; then
          echo "Decoding Base64 PROD wallet..."
          echo "${{ secrets.ADB_PROD_WALLET }}" | base64 -d > $HOME/prod_wallet.zip
          unzip -o $HOME/prod_wallet.zip -d $HOME/adb_wallet_prod
        else
          echo "Using wallet_prod/ folder from repo..."
          cp -r $GITHUB_WORKSPACE/wallet_prod/* $HOME/adb_wallet_prod/ 2>/dev/null || true
        fi
        
        chmod 600 $HOME/adb_wallet_prod/* || true

        cat > $HOME/adb_wallet_prod/sqlnet.ora <<EOF
        WALLET_LOCATION = (SOURCE = (METHOD = file)(METHOD_DATA = (DIRECTORY="$HOME/adb_wallet_prod")))
        SSL_SERVER_DN_MATCH = yes

        TRACE_LEVEL_CLIENT = USER
        TRACE_DIRECTORY_CLIENT = $HOME/adb_wallet_prod
        TRACE_FILE_CLIENT = trace_prod.log
        DIAG_ADR_ENABLED = OFF
        EOF

        echo "--- PROD WALLET CONTENTS ---"
        ls -R $HOME/adb_wallet_prod

    - name: Show PROD tnsnames.ora
      run: |
        echo "--- PROD tnsnames.ora ---"
        cat $HOME/adb_wallet_prod/tnsnames.ora

    - name: DNS Debug for PROD host
      run: |
        PROD_HOST=$(grep -oP '(?<=HOST = ).*(?=\))' $HOME/adb_wallet_prod/tnsnames.ora | head -n1)
        echo "PROD HOST = $PROD_HOST"

        echo "--- nslookup ---"
        nslookup $PROD_HOST || true

        echo "--- dig ---"
        dig $PROD_HOST || true

        echo "--- ping ---"
        ping -c 4 $PROD_HOST || true

    - name: Test SQL Connection (PROD) With Verbose Logs
      run: |
        export TNS_ADMIN=$HOME/adb_wallet_prod
        export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH
        export PATH=$HOME/instantclient_19_27:$PATH

        echo "CONNECT STRING = ${{ secrets.ADB_PROD_USER }}/${{ secrets.ADB_PROD_PASSWORD }}@${{ secrets.ADB_PROD_TNS }}"

        echo "--- WALLET FILES ---"
        ls -l $TNS_ADMIN

        echo "--- SQLPLUS DEBUG ---"
        sqlplus -lint -prelim /nolog <<EOF
        conn ${{ secrets.ADB_PROD_USER }}/${{ secrets.ADB_PROD_PASSWORD }}@${{ secrets.ADB_PROD_TNS }}
        EOF

        echo "--- TRACE LOG (if exists) ---"
        cat $HOME/adb_wallet_prod/trace_prod.log || true

