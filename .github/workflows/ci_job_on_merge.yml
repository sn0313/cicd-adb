name: CI for DB Changes

on:
  push:
    branches:
      - main  # Trigger only when merged into main

jobs:
  validate-sql:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Oracle Instant Client + SQL*Plus
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1t64 unzip wget
          sudo ln -s /lib/x86_64-linux-gnu/libaio.so.1t64 /lib/x86_64-linux-gnu/libaio.so.1
          wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-basic-linux.x64-19.27.0.0.0dbru.zip
          unzip -o instantclient-basic-linux.x64-19.27.0.0.0dbru.zip -d $HOME
          wget https://download.oracle.com/otn_software/linux/instantclient/1927000/instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip
          unzip -o instantclient-sqlplus-linux.x64-19.27.0.0.0dbru.zip -d $HOME
          export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH
          export PATH=$HOME/instantclient_19_27:$PATH
          sqlplus -v

      - name: Prepare Wallet
        run: |
          mkdir -p $HOME/adb_wallet
          cp -r $GITHUB_WORKSPACE/wallet/dev/* $HOME/adb_wallet/
          chmod 600 $HOME/adb_wallet/*
          cat > $HOME/adb_wallet/sqlnet.ora <<EOF
WALLET_LOCATION = (SOURCE = (METHOD = file) (METHOD_DATA = (DIRECTORY="$HOME/adb_wallet")))
SSL_SERVER_DN_MATCH = yes
EOF

      - name: Run SQL Scripts
        env:
          ADB_USER: ${{ secrets.ADB_USER }}
          ADB_PASSWORD: ${{ secrets.ADB_PASSWORD }}
          ADB_TNS: ${{ secrets.ADB_TNS }}
        run: |
          export TNS_ADMIN=$HOME/adb_wallet
          export LD_LIBRARY_PATH=$HOME/instantclient_19_27:$LD_LIBRARY_PATH
          export PATH=$HOME/instantclient_19_27:$PATH

          for sql_file in $GITHUB_WORKSPACE/sql/*.sql; do
            echo "Running $sql_file..."
            sqlplus "$ADB_USER/$ADB_PASSWORD@$ADB_TNS" @"$sql_file"
          done
